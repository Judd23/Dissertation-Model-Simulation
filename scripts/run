#!/usr/bin/env bash
# ==============================================================================
# scripts/run — One-button orchestrator for manifest-driven SEM pipeline
# ==============================================================================
#
# Usage:
#   ./scripts/run smoke        # Quick test run (minimal bootstrap)
#   ./scripts/run main         # Standard run (moderate bootstrap)
#   ./scripts/run Full_Deploy  # Production run (full bootstrap)
#
# Requirements:
#   - Docker (for rocker/verse R environment) OR SKIP_DOCKER=1
#   - Python 3.9+ with .venv at repo root
#
# Environment Variables (optional):
#   RUN_ID        Override auto-generated run ID (required for RESUME=1)
#   RESUME        Set to 1 to resume an interrupted run (requires RUN_ID)
#   SKIP_DOCKER   Set to 1 to run R locally instead of in Docker
#   BOOT_NCPUS    Number of CPU cores for bootstrap (default: 4)
#   SKIP_RQ4      Set to 1 to skip RQ4 measurement invariance
#   SKIP_RQ4_STRUCT_MG  Set to 1 to skip RQ4 structural multi-group
#
# Resume Example:
#   RUN_ID=run_01_20_0315p RESUME=1 ./scripts/run Full_Deploy
#
# ==============================================================================

set -eo pipefail

# -----------------------------------------------------------------------------
# Configuration
# -----------------------------------------------------------------------------

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# -----------------------------------------------------------------------------
# Helper functions
# -----------------------------------------------------------------------------

log_info() {
  echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
  echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warn() {
  echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
  echo -e "${RED}[ERROR]${NC} $1" >&2
}

# -----------------------------------------------------------------------------
# Progress tracker for Full_Deploy (bash 3.2 compatible)
# -----------------------------------------------------------------------------

# Stage status stored as individual variables (no associative arrays)
STATUS_R_PIPELINE="pending"
STATUS_MANIFEST_CHECK="pending"
STATUS_PYTHON_STAGE="pending"
STATUS_WEBAPP_SYNC="pending"

START_R_PIPELINE=0
START_MANIFEST_CHECK=0
START_PYTHON_STAGE=0
START_WEBAPP_SYNC=0

get_status() {
  case "$1" in
    R_PIPELINE) echo "$STATUS_R_PIPELINE" ;;
    MANIFEST_CHECK) echo "$STATUS_MANIFEST_CHECK" ;;
    PYTHON_STAGE) echo "$STATUS_PYTHON_STAGE" ;;
    WEBAPP_SYNC) echo "$STATUS_WEBAPP_SYNC" ;;
  esac
}

set_status() {
  case "$1" in
    R_PIPELINE) STATUS_R_PIPELINE="$2" ;;
    MANIFEST_CHECK) STATUS_MANIFEST_CHECK="$2" ;;
    PYTHON_STAGE) STATUS_PYTHON_STAGE="$2" ;;
    WEBAPP_SYNC) STATUS_WEBAPP_SYNC="$2" ;;
  esac
}

get_start_time() {
  case "$1" in
    R_PIPELINE) echo "$START_R_PIPELINE" ;;
    MANIFEST_CHECK) echo "$START_MANIFEST_CHECK" ;;
    PYTHON_STAGE) echo "$START_PYTHON_STAGE" ;;
    WEBAPP_SYNC) echo "$START_WEBAPP_SYNC" ;;
  esac
}

set_start_time() {
  case "$1" in
    R_PIPELINE) START_R_PIPELINE="$2" ;;
    MANIFEST_CHECK) START_MANIFEST_CHECK="$2" ;;
    PYTHON_STAGE) START_PYTHON_STAGE="$2" ;;
    WEBAPP_SYNC) START_WEBAPP_SYNC="$2" ;;
  esac
}

init_progress() {
  STATUS_R_PIPELINE="pending"
  STATUS_MANIFEST_CHECK="pending"
  STATUS_PYTHON_STAGE="pending"
  STATUS_WEBAPP_SYNC="pending"
}

show_progress() {
  echo ""
  echo "┌──────────────────────────────────────────────────────────────┐"
  echo "│              FULL DEPLOY PROGRESS                            │"
  echo "├──────────────────────────────────────────────────────────────┤"
  
  for pair in "R_PIPELINE:R Pipeline (SEM + Bootstrap)" \
              "MANIFEST_CHECK:Verify Manifest" \
              "PYTHON_STAGE:Python Stage (Tables/Figures)" \
              "WEBAPP_SYNC:Sync to Webapp"; do
    local key="${pair%%:*}"
    local label="${pair#*:}"
    local status=$(get_status "$key")
    local icon="" elapsed_str=""
    
    case "$status" in
      pending) icon="○" ;;
      running) icon="◉"
               local st=$(get_start_time "$key")
               if [[ "$st" -gt 0 ]]; then
                 elapsed_str=" ($(($(date +%s) - st))s)"
               fi ;;
      done)    icon="✓" ;;
      failed)  icon="✗" ;;
    esac
    printf "│  %s %-50s │\n" "$icon" "${label}${elapsed_str}"
  done
  
  echo "└──────────────────────────────────────────────────────────────┘"
  echo ""
}

start_stage() {
  set_status "$1" "running"
  set_start_time "$1" "$(date +%s)"
  show_progress
}

complete_stage() {
  local st=$(get_start_time "$1")
  local elapsed=$(($(date +%s) - st))
  set_status "$1" "done"
  log_success "Stage complete: $1 (${elapsed}s)"
}

fail_stage() {
  set_status "$1" "failed"
  show_progress
}

generate_run_id() {
  # Format: run_MM_DD_HHMMp (e.g., run_01_19_0337p)
  local hour=$(date +%H)
  local ampm="a"
  if [[ $hour -ge 12 ]]; then
    ampm="p"
  fi
  if [[ $hour -gt 12 ]]; then
    hour=$((hour - 12))
  fi
  if [[ $hour -eq 0 ]]; then
    hour=12
  fi
  printf "run_%s_%02d%s%s\n" "$(date +%m_%d)" "$hour" "$(date +%M)" "$ampm"
}

check_dependencies() {
  local missing=()
  
  if [[ -z "${SKIP_DOCKER:-}" ]] && ! command -v docker &> /dev/null; then
    missing+=("docker")
  fi
  
  if [[ ! -d "$REPO_ROOT/.venv" ]]; then
    missing+=(".venv (Python virtual environment)")
  fi
  
  if [[ ${#missing[@]} -gt 0 ]]; then
    log_error "Missing dependencies: ${missing[*]}"
    log_error "Please install/create them before running."
    exit 1
  fi
}

# -----------------------------------------------------------------------------
# Main execution
# -----------------------------------------------------------------------------

main() {
  local mode="${1:-smoke}"
  
  # Validate mode and set bootstrap settings
  case "$mode" in
    smoke)
      B_BOOT_MAIN="${B_BOOT_MAIN:-10}"
      B_BOOT_MG="${B_BOOT_MG:-1}"
      BOOT_CI_TYPE_MAIN="${BOOT_CI_TYPE_MAIN:-perc}"
      ;;
    main)
      B_BOOT_MAIN="${B_BOOT_MAIN:-500}"
      B_BOOT_MG="${B_BOOT_MG:-1}"
      BOOT_CI_TYPE_MAIN="${BOOT_CI_TYPE_MAIN:-bca.simple}"
      ;;
    Full_Deploy)
      B_BOOT_MAIN="${B_BOOT_MAIN:-2000}"
      B_BOOT_MG="${B_BOOT_MG:-1}"
      BOOT_CI_TYPE_MAIN="${BOOT_CI_TYPE_MAIN:-bca.simple}"
      BOOT_NCPUS="${BOOT_NCPUS:-8}"
      SKIP_RQ4="${SKIP_RQ4:-0}"
      SKIP_RQ4_STRUCT_MG="${SKIP_RQ4_STRUCT_MG:-0}"
      ;;
    *)
      log_error "Invalid mode: $mode"
      echo "Valid modes: smoke, main, Full_Deploy"
      exit 1
      ;;
  esac
  
  log_info "Starting pipeline in '$mode' mode..."
  
  # Check dependencies
  check_dependencies
  
  # Generate or use provided RUN_ID
  local run_id="${RUN_ID:-$(generate_run_id)}"
  export RUN_ID="$run_id"
  export RUN_MODE="$mode"
  
  log_info "Run ID: $run_id"
  log_info "Run Mode: $mode"
  
  # Export bootstrap settings
  export B_BOOT_MAIN
  export B_BOOT_MG
  export BOOT_CI_TYPE_MAIN
  
  # Set common environment variables (mode-specific defaults set above)
  export MANIFEST_FIRST_PYTHON="${MANIFEST_FIRST_PYTHON:-FALSE}"
  export SKIP_WEBAPP_SYNC="${SKIP_WEBAPP_SYNC:-FALSE}"
  export BOOT_NCPUS="${BOOT_NCPUS:-4}"  # Full_Deploy default: 8
  export SKIP_RQ4="${SKIP_RQ4:-0}"       # Full_Deploy default: 1
  export SKIP_RQ4_STRUCT_MG="${SKIP_RQ4_STRUCT_MG:-0}"
  
  # Define output paths
  local run_dir="$REPO_ROOT/4_Model_Results/Outputs/runs/$run_id"
  local manifest_path="$run_dir/manifest.json"
  local webapp_results="$REPO_ROOT/webapp/public/results"
  local resume_marker="$run_dir/.resume_state"
  
  # Initialize progress tracker
  init_progress
  
  # -------------------------------------------------------------------------
  # Resume detection
  # -------------------------------------------------------------------------
  
  local skip_r_pipeline=false
  local skip_python_stage=false
  
  if [[ "${RESUME:-0}" == "1" ]]; then
    if [[ -z "${RUN_ID:-}" ]]; then
      log_error "RESUME=1 requires RUN_ID to be set"
      log_error "Example: RUN_ID=run_01_20_0315p RESUME=1 ./scripts/run Full_Deploy"
      exit 1
    fi
    
    if [[ ! -d "$run_dir" ]]; then
      log_error "Cannot resume: run directory not found: $run_dir"
      exit 1
    fi
    
    log_warn "RESUME mode enabled for run: $run_id"
    
    # Check what stages are already complete
    if [[ -f "$manifest_path" ]]; then
      log_info "Manifest exists — skipping R pipeline"
      skip_r_pipeline=true
      set_status "R_PIPELINE" "done"
      set_status "MANIFEST_CHECK" "done"
    fi
    
    # Check if Python stage completed (tables exist)
    if [[ -f "$run_dir/tables/Dissertation_Tables.docx" ]]; then
      log_info "Tables exist — skipping Python stage"
      skip_python_stage=true
      set_status "PYTHON_STAGE" "done"
    fi
    
    show_progress
  fi
  
  # -------------------------------------------------------------------------
  # Stage 1: R Pipeline (via Docker or local)
  # -------------------------------------------------------------------------
  
  if [[ "$skip_r_pipeline" == "true" ]]; then
    log_info "=== Stage 1: R Pipeline (SKIPPED - already complete) ==="
  else
    start_stage "R_PIPELINE"
    log_info "=== Stage 1: R Pipeline ==="
  
  if [[ -z "${SKIP_DOCKER:-}" ]]; then
    log_info "Running R in Docker (rocker/verse:4.4.0)..."
    
    docker run --rm \
      -v "$REPO_ROOT:/workspace" \
      -w /workspace \
      -e RUN_ID="$run_id" \
      -e RUN_MODE="$mode" \
      -e B_BOOT_MAIN="${B_BOOT_MAIN:-10}" \
      -e B_BOOT_MG="${B_BOOT_MG:-4}" \
      -e BOOT_CI_TYPE_MAIN="${BOOT_CI_TYPE_MAIN:-perc}" \
      -e BOOT_NCPUS="${BOOT_NCPUS:-4}" \
      -e MANIFEST_FIRST_PYTHON="$MANIFEST_FIRST_PYTHON" \
      -e SKIP_WEBAPP_SYNC="$SKIP_WEBAPP_SYNC" \
      rocker/verse:4.4.0 \
      Rscript 3_Analysis/1_Main_Pipeline_Code/run_all_RQs_official.R
  else
    log_warn "SKIP_DOCKER=1 — Running R locally..."
    cd "$REPO_ROOT"
    Rscript 3_Analysis/1_Main_Pipeline_Code/run_all_RQs_official.R
  fi
  
  complete_stage "R_PIPELINE"
  fi  # end skip_r_pipeline check
  
  # -------------------------------------------------------------------------
  # Stage 2: Verify manifest exists
  # -------------------------------------------------------------------------
  
  if [[ "$skip_r_pipeline" != "true" ]]; then
    start_stage "MANIFEST_CHECK"
    log_info "=== Stage 2: Verify Manifest ==="
  
    if [[ ! -f "$manifest_path" ]]; then
      fail_stage "MANIFEST_CHECK"
      log_error "CRITICAL: manifest.json not found at $manifest_path"
      log_error "R pipeline may have failed. Check logs in:"
      log_error "  $run_dir/logs/"
      exit 1
    fi
  
    log_success "Manifest found: $manifest_path"
    complete_stage "MANIFEST_CHECK"
  fi  # end skip_r_pipeline manifest check
  
  # -------------------------------------------------------------------------
  # Stage 3: Python stage (manifest-first)
  # -------------------------------------------------------------------------
  
  if [[ "$skip_python_stage" == "true" ]]; then
    log_info "=== Stage 3: Python Stage (SKIPPED - already complete) ==="
  else
    start_stage "PYTHON_STAGE"
    log_info "=== Stage 3: Python Stage ==="
  
    # Activate venv and run Python stage
    source "$REPO_ROOT/.venv/bin/activate"
  
    if [[ -f "$REPO_ROOT/3_Analysis/run_python_stage.py" ]]; then
      log_info "Running manifest-first Python stage..."
      python "$REPO_ROOT/3_Analysis/run_python_stage.py" --manifest "$manifest_path"
    else
      log_warn "run_python_stage.py not found, skipping Python stage"
    fi
  
    complete_stage "PYTHON_STAGE"
  fi  # end skip_python_stage check
  
  # -------------------------------------------------------------------------
  # Stage 4: Sync to webapp
  # -------------------------------------------------------------------------
  
  start_stage "WEBAPP_SYNC"
  log_info "=== Stage 4: Sync to Webapp ==="
  
  # Activate venv (may already be active, but ensure it)
  source "$REPO_ROOT/.venv/bin/activate"
  
  python "$REPO_ROOT/scripts/sync_run_to_webapp.py" --run-dir "$run_dir"
  
  log_success "Synced to: $webapp_results/$run_id/"
  complete_stage "WEBAPP_SYNC"
  
  # -------------------------------------------------------------------------
  # Final Summary
  # -------------------------------------------------------------------------
  
  show_progress "COMPLETE"
  
  echo ""
  echo "============================================================"
  log_success "Pipeline complete!"
  echo "============================================================"
  echo ""
  echo "  Run ID:       $run_id"
  echo "  Mode:         $mode"
  echo "  Artifacts:    $run_dir/"
  echo "  Webapp copy:  $webapp_results/$run_id/"
  echo ""
  echo "To view in webapp:"
  echo "  cd webapp && npm run dev"
  echo "  Open http://localhost:5173/#/runs"
  echo ""
  echo "============================================================"
}

# Run main with all arguments
main "$@"
