#!/usr/bin/env bash
# ==============================================================================
# scripts/run — One-button orchestrator for manifest-driven SEM pipeline
# ==============================================================================
#
# Usage:
#   ./scripts/run smoke        # Quick test run (minimal bootstrap)
#   ./scripts/run main         # Standard run (moderate bootstrap)
#   ./scripts/run Full_Deploy  # Production run (full bootstrap)
#
# Requirements:
#   - Docker (for rocker/verse R environment)
#   - Python 3.9+ with .venv at repo root
#
# Environment Variables (optional):
#   RUN_ID        Override auto-generated run ID
#   SKIP_DOCKER   Set to 1 to run R locally instead of in Docker
#
# ==============================================================================

set -euo pipefail

# -----------------------------------------------------------------------------
# Configuration
# -----------------------------------------------------------------------------

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Mode defaults (can be overridden by mode argument)
declare -A BOOTSTRAP_SETTINGS=(
  [smoke]="B_BOOT_MAIN=10 B_BOOT_MG=4 BOOT_CI_TYPE_MAIN=perc"
  [main]="B_BOOT_MAIN=500 B_BOOT_MG=4 BOOT_CI_TYPE_MAIN=bca.simple"
  [Full_Deploy]="B_BOOT_MAIN=2000 B_BOOT_MG=100 BOOT_CI_TYPE_MAIN=bca.simple"
)

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# -----------------------------------------------------------------------------
# Helper functions
# -----------------------------------------------------------------------------

log_info() {
  echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
  echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warn() {
  echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
  echo -e "${RED}[ERROR]${NC} $1" >&2
}

generate_run_id() {
  echo "run_$(date +%Y%m%d_%H%M%S)"
}

check_dependencies() {
  local missing=()
  
  if [[ -z "${SKIP_DOCKER:-}" ]] && ! command -v docker &> /dev/null; then
    missing+=("docker")
  fi
  
  if [[ ! -d "$REPO_ROOT/.venv" ]]; then
    missing+=(".venv (Python virtual environment)")
  fi
  
  if [[ ${#missing[@]} -gt 0 ]]; then
    log_error "Missing dependencies: ${missing[*]}"
    log_error "Please install/create them before running."
    exit 1
  fi
}

# -----------------------------------------------------------------------------
# Main execution
# -----------------------------------------------------------------------------

main() {
  local mode="${1:-smoke}"
  
  # Validate mode
  if [[ ! "${BOOTSTRAP_SETTINGS[$mode]+isset}" ]]; then
    log_error "Invalid mode: $mode"
    echo "Valid modes: smoke, main, Full_Deploy"
    exit 1
  fi
  
  log_info "Starting pipeline in '$mode' mode..."
  
  # Check dependencies
  check_dependencies
  
  # Generate or use provided RUN_ID
  local run_id="${RUN_ID:-$(generate_run_id)}"
  export RUN_ID="$run_id"
  export RUN_MODE="$mode"
  
  log_info "Run ID: $run_id"
  log_info "Run Mode: $mode"
  
  # Parse bootstrap settings for this mode
  local settings="${BOOTSTRAP_SETTINGS[$mode]}"
  for setting in $settings; do
    export "$setting"
  done
  
  # Set common environment variables
  export MANIFEST_FIRST_PYTHON=FALSE  # Use legacy mode (Python called from R)
  export SKIP_WEBAPP_SYNC=FALSE       # Enable sync to webapp
  export BOOT_NCPUS="${BOOT_NCPUS:-4}"
  
  # Define output paths
  local run_dir="$REPO_ROOT/4_Model_Results/Outputs/runs/$run_id"
  local manifest_path="$run_dir/manifest.json"
  local webapp_results="$REPO_ROOT/webapp/public/results"
  
  # -------------------------------------------------------------------------
  # Stage 1: R Pipeline (via Docker or local)
  # -------------------------------------------------------------------------
  
  log_info "=== Stage 1: R Pipeline ==="
  
  if [[ -z "${SKIP_DOCKER:-}" ]]; then
    log_info "Running R in Docker (rocker/verse:4.4.0)..."
    
    docker run --rm \
      -v "$REPO_ROOT:/workspace" \
      -w /workspace \
      -e RUN_ID="$run_id" \
      -e RUN_MODE="$mode" \
      -e B_BOOT_MAIN="${B_BOOT_MAIN:-10}" \
      -e B_BOOT_MG="${B_BOOT_MG:-4}" \
      -e BOOT_CI_TYPE_MAIN="${BOOT_CI_TYPE_MAIN:-perc}" \
      -e BOOT_NCPUS="${BOOT_NCPUS:-4}" \
      -e MANIFEST_FIRST_PYTHON="$MANIFEST_FIRST_PYTHON" \
      -e SKIP_WEBAPP_SYNC="$SKIP_WEBAPP_SYNC" \
      rocker/verse:4.4.0 \
      Rscript 3_Analysis/1_Main_Pipeline_Code/run_all_RQs_official.R
  else
    log_warn "SKIP_DOCKER=1 — Running R locally..."
    cd "$REPO_ROOT"
    Rscript 3_Analysis/1_Main_Pipeline_Code/run_all_RQs_official.R
  fi
  
  # -------------------------------------------------------------------------
  # Stage 2: Verify manifest exists
  # -------------------------------------------------------------------------
  
  log_info "=== Stage 2: Verify Manifest ==="
  
  if [[ ! -f "$manifest_path" ]]; then
    log_error "CRITICAL: manifest.json not found at $manifest_path"
    log_error "R pipeline may have failed. Check logs in:"
    log_error "  $run_dir/logs/"
    exit 1
  fi
  
  log_success "Manifest found: $manifest_path"
  
  # -------------------------------------------------------------------------
  # Stage 3: Python stage (manifest-first)
  # -------------------------------------------------------------------------
  
  log_info "=== Stage 3: Python Stage ==="
  
  # Activate venv and run Python stage
  source "$REPO_ROOT/.venv/bin/activate"
  
  if [[ -f "$REPO_ROOT/3_Analysis/run_python_stage.py" ]]; then
    log_info "Running manifest-first Python stage..."
    python "$REPO_ROOT/3_Analysis/run_python_stage.py" --manifest "$manifest_path"
  else
    log_warn "run_python_stage.py not found, skipping Python stage"
  fi
  
  # -------------------------------------------------------------------------
  # Stage 4: Sync to webapp
  # -------------------------------------------------------------------------
  
  log_info "=== Stage 4: Sync to Webapp ==="
  
  python "$REPO_ROOT/scripts/sync_run_to_webapp.py" --run-dir "$run_dir"
  
  log_success "Synced to: $webapp_results/$run_id/"
  
  # -------------------------------------------------------------------------
  # Stage 5: Summary
  # -------------------------------------------------------------------------
  
  echo ""
  echo "============================================================"
  log_success "Pipeline complete!"
  echo "============================================================"
  echo ""
  echo "  Run ID:       $run_id"
  echo "  Mode:         $mode"
  echo "  Artifacts:    $run_dir/"
  echo "  Webapp copy:  $webapp_results/$run_id/"
  echo ""
  echo "To view in webapp:"
  echo "  cd webapp && npm run dev"
  echo "  Open http://localhost:5173/#/runs"
  echo ""
  echo "============================================================"
}

# Run main with all arguments
main "$@"
